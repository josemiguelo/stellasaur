#!/bin/bash

# Logic from bluefin-dx-groups for state tracking
STATE_FILE="/etc/stellasaur/custom-groups-v1"
if [[ -f $STATE_FILE ]]; then
  echo "Group setup has already run. Exiting..."
  exit 0
else
  echo "Group setup has not run yet. Proceeding..."
fi

# Group definitions to ensure they exist in /etc/group
append_group() {
  if ! grep -q "^$1:" /etc/group; then
    grep "^$1:" /usr/lib/group >>/etc/group
  else
    echo "Group $1 already exists in /etc/group"
  fi
}

# Ensure i2c group exists
append_group i2c

# Get users in the wheel group
WHEEL_USERS=$(getent group wheel | awk -F: '{print $4}' | tr ',' ' ')
echo "Wheel group users: $WHEEL_USERS"

for user in $WHEEL_USERS; do
  echo "Adding $user to i2c group"
  usermod -aG i2c "$user"
done

mkdir -p /etc/stellasaur
touch "$STATE_FILE"
